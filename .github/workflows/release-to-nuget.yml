name: Release to NuGet

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: windows-latest  # Changed to Windows for MSBuild compatibility
    timeout-minutes: 5

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 8.0.x  # Ensure using .NET 8.0.x version

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.3.1  # Add MSBuild setup for build and pack tasks

    - name: Restore dependencies
      run: dotnet restore  # Restore dependencies before building

    - name: Build
      run: dotnet build -c Release --no-restore  # Build the project without restoring dependencies again

    - name: Test
      run: dotnet test -c Release --no-build --verbosity normal  # Run tests without rebuilding

    - name: Pack NuGet Packages
      run: dotnet pack -c Release --no-build --output ./nupkgs  # Pack NuGet packages

    - name: Push to NuGet
      run: dotnet nuget push "./nupkgs/*.nupkg" --api-key ${{ secrets.nuget_api_key }} --source https://api.nuget.org/v3/index.json --skip-duplicate
